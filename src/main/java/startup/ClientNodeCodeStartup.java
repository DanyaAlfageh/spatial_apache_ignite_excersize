package startup;

import config.ClientConfigurationFactory;
import model.Point;
import model.Rectangle;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.io.PrintStream;
import java.text.ParseException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Random;

import org.apache.ignite.Ignite;
import org.apache.ignite.IgniteCache;
import org.apache.ignite.IgniteCompute;
import org.apache.ignite.Ignition;
import org.apache.ignite.cache.CachePeekMode;
import org.apache.ignite.cache.query.ScanQuery;
import org.apache.ignite.lang.IgniteBiPredicate;
import org.apache.ignite.lang.IgniteRunnable;

/** This file was generated by Ignite Web Console (02/11/2021, 12:55) **/
public class ClientNodeCodeStartup {
    /**
     * Start up node with specified configuration.
     * 
     * @param args Command line arguments, none required.
     * @throws Exception If failed.
     **/
	static Rectangle spaceMbr;
	static IgniteCache<Integer, File> fcache;
	static IgniteCache<String, Rectangle> ccache;
	static Ignite ignite;
	static int qCount = 3949;
	static int i=0;
	static int key;
	private static Map <String,IgniteCache<Integer, ArrayList<Point>>> cacheMap;
	
	private static File loadFiles(Ignite ignite, String path) {

		fcache = ignite.getOrCreateCache("FileCache");
		File f = new File(path);
		fcache.put(key, f);
		key++;
		return fcache.get(key-1);
		}
	
	static void createCachesFromFile(Ignite ignite) throws IOException {

		 cacheMap = new HashMap <String,IgniteCache<Integer, ArrayList<Point>>>();
		 
		 BufferedReader br = new BufferedReader(new FileReader(fcache.get(0)));
		 ccache = ignite.getOrCreateCache("Rectangles");
		 String line = null;
		 while ((line = br.readLine()) != null) {
			 
		   String[] parts = line.split(",");
		   int next = Integer.parseInt(parts[0]);
		   IgniteCache<Integer, ArrayList<Point>> pcache = ignite.getOrCreateCache("Cache---"+next);
		   cacheMap.put("Cache---"+next, pcache);
		   ccache.put(pcache.getName(), new Rectangle(Double.parseDouble(parts[1]),Double.parseDouble(parts[2]),
				   Double.parseDouble(parts[3]),Double.parseDouble(parts[4])));

		 }
		 br.close();
		 
	}
	public static void insert(Ignite ignite)throws ParseException, NumberFormatException, IOException {
		String line = null;
		for(int i=0;i<qCount;i++) {
			BufferedReader br = new BufferedReader(new FileReader(fcache.get(1)));
			Rectangle rect = ccache.get("Cache---"+i);
			ArrayList<Point> p = new ArrayList<Point>();

			 while ((line = br.readLine()) != null) {
			   String[] parts = line.split(",");
			   double x = Double.parseDouble(parts[1]);
			   double y = Double.parseDouble(parts[2]);
			   Point point = new Point(x,y);
			   if(rect.contains(point)) {
				   p.add(point);
			   	}
			   }
			 ignite.cache("Cache---"+i).put(0, p);
			 br.close();
		}


	}

	@SuppressWarnings("unchecked")
	public static void printCahces(Ignite ignite) {
		int s=0;
		for (int key = 0; key < qCount; key++) {
			 String name = ignite.cache("Cache---"+key).getName();
			 ArrayList<Point> p = ((ArrayList<Point>) ignite.cache(name).get(0));
			 if(p!=null)
				 s=s+p.size(); 
			 System.out.println("The Cache " + key + ", Has " +p.size()+" points");

			 
		}
		
	}
	
	public static void rangeQuery(Rectangle s, Ignite ignite) throws FileNotFoundException {
		
	    File file = new File("D:\\RangeQueryOutput.txt");
	      //Instantiating the PrintStream class
	   PrintStream stream = new PrintStream(file);

		int key=0;
		IgniteCache <String,Rectangle> cache = ignite.cache("Rectangles");
		ArrayList<String> result = new ArrayList<String>();
		boolean found=true;
		while(found&&key<qCount) {
			Rectangle rect = cache.get("Cache---"+key);
			if(rect.isIntersected(s)) {
				result.add("Cache---"+key);
				
			}
			else {
				//found=false;
			}
			key++;
		}

		ArrayList<Point> foundPoints = new ArrayList<Point>();
		for(int i=0; i<result.size();i++) {
			IgniteCache<Integer, ArrayList<Point>> pcache = cacheMap.get(result.get(i));
			ArrayList<Point> points= pcache.get(0);
			for(Point p : points) {
				if(s.contains(p)) {
					foundPoints.add(p);
				}
			}
		}
		for(int i=0; i<result.size();i++) {
		    System.setOut(stream);
			System.out.println("Caches: "+result.get(i)+" is in the range.");
		}
		for(int i=0; i<foundPoints.size();i++) {
			System.out.println("Point: "+foundPoints.get(i)+" is in the range.");
		}
	}
	

    public static void main(String[] args) throws Exception {
        ignite = Ignition.start(ClientConfigurationFactory.createConfiguration());          
        loadFiles(ignite, "D:\\test_mbrsz7.txt");
        createCachesFromFile(ignite);  
        loadFiles(ignite,"C:\\green.txt");
        insert(ignite);
        printCahces(ignite);
        rangeQuery(new Rectangle(-73.916015625,40.64501953125,-73.828125,40.83837890625),ignite);
        ignite.destroyCaches(ignite.cacheNames());
        System.out.println(ignite.cacheNames());
        ignite.close();
    }
}